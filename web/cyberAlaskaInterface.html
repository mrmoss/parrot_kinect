<!DOCTYPE html>
<html>
<head>
  <title>CyberAlaska UAV Interface</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <style type="text/css"><!--
    table {margin: 0px; padding: 0px;}
    td {margin: 0px; padding: 0px;}
    tr {margin: 0px; padding: 0px;}
    body {margin: 0px; padding: 0px;}
    #if_container {
      border-style: outset;
      border-color: black;
      border-width: 1px;
    }
    #video_container {
      border-style: outset;
      border-color: black;
      border-width: 1px;
    }
    .normalMsg {
      color: black;
    }
    .errorMsg {
      color: red;
    } -->

  </style>
</head>

<body onload="init()">

<table>
<tr>
  <td>
    <div id="if_container" onclick="getCoords(event)"></div>
  </td>
  <td>
    <div id="video_container"></div>
  </td>
</tr>
<tr>
  <td colspan="2">
    <input type="button" id="take-off" value="Take off" onclick="takeOff()" />
    <input type="button" id="land" value="Land" onclick="land()" />
    <input type="button" id="pause" value="Pause" onclick="togglePause()" />
  </td>
</tr>
<tr>
  <td colspan="2">
    <div id="messages"></div>
  </td>
</tr>
</table>

</body>


<script src="js/three.js"></script>
<script src="js/Detector.js"></script>
<script src="js/jquery-1.9.1.min.js"></script>

<script type = text/javascript>

var mouseX, mouseY;
var container, v_container, camera1, camera2, scene1, scene2, if_renderer, video_renderer;

// for the arrow animation
var arrow, arrowTex, currentFrame, totalFrames;
var clock, elapsedTime = 0;

var request = new XMLHttpRequest();
var message_count = 0;

var paused = false;

var video;
var data_array;
var videoWidth  = 640 /2;
var videoHeight = 360 /2;

var IF_ASPECT_RATIO  = 1.0;
var IF_HEIGHT = $(window).height() * 0.7;
var IF_WIDTH = IF_HEIGHT * IF_ASPECT_RATIO;

var VIDEO_ASPECT_RATIO  = videoWidth / videoHeight;
var VIDEO_HEIGHT = $(window).height() * 0.7;
var VIDEO_WIDTH = VIDEO_HEIGHT * VIDEO_ASPECT_RATIO;


function init()
{
  // Chech for webgl implementation
  if(!Detector.webgl)
  {
    Detector.addGetWebGLMessage();
  }

  var VIEW_ANGLE   = 60;
  var NEAR_CLIP = .1, FAR_CLIP = 20;

  clock  = new THREE.Clock();
  scene1 = new THREE.Scene();
  scene2 = new THREE.Scene();

  // Setup interface camera
  camera1 = new THREE.PerspectiveCamera(VIEW_ANGLE, IF_ASPECT_RATIO, NEAR_CLIP, FAR_CLIP);
  scene1.add(camera1);
  camera1.position.set(0,0,10.4);
  camera1.lookAt(scene1.position);

  // Setup video camera
  camera2 = new THREE.PerspectiveCamera(VIEW_ANGLE, VIDEO_ASPECT_RATIO, NEAR_CLIP, FAR_CLIP);
  scene2.add(camera2);
  camera2.position.set(0,0,10.4);
  camera2.lookAt(scene2.position);

  // Setup Renderer
  if_renderer    = new THREE.WebGLRenderer( {antialias:true} );
  video_renderer = new THREE.WebGLRenderer( {antialias:true} );

  // setup layout based on browser window size
  resizeFunc();
  $(window).resize(resizeFunc);

  // create a div elements to contain the renderers
  container = document.getElementById( "if_container" );
  container.appendChild( if_renderer.domElement );
  v_container = document.getElementById("video_container");
  v_container.appendChild( video_renderer.domElement );

  // create the map of the challenge arena
  var mapWidth = mapHeight = 12; // In feet
  var wIncrement = hIncrement = 1;

  var mapGeometry = new THREE.PlaneGeometry(mapWidth, mapHeight, wIncrement, hIncrement);
  var mapMaterial = new THREE.MeshBasicMaterial(
    { map: THREE.ImageUtils.loadTexture("images/SampleMap.jpg") } );
  var arenaMap = new THREE.Mesh(mapGeometry, mapMaterial);
  scene1.add(arenaMap);

  // create the viewing plane for the video feed
  data_array=new Uint8Array(videoWidth*videoHeight*3);

  for(var ii=0;ii<videoWidth*videoHeight;++ii)
  {
    data_array[ii*3+0]=255;
    data_array[ii*3+1]=0;
    data_array[ii*3+2]=0;
  }

  mapWidth  = mapHeight * VIDEO_ASPECT_RATIO;
  var videoGeometry = new THREE.PlaneGeometry(mapWidth, mapHeight, wIncrement, hIncrement);
  var map = new THREE.DataTexture(data_array, videoWidth, videoHeight, THREE.RGBFormat );
  map.needsUpdate = true;
  var videoMaterial = new THREE.MeshBasicMaterial(
    { map: map } );
  video = new THREE.Mesh(videoGeometry, videoMaterial);
  scene2.add(video);

  // create object to display arrow animation
  var arrowWidth = arrowHeight = 1;
  totalFrames = 10;
  arrowTex = THREE.ImageUtils.loadTexture("images/ArrowAnimation.gif");
  arrowTex.wrapS = arrowTex.wrapT = THREE.RepeatWrapping;
  arrowTex.repeat.set(1/totalFrames, 1);
  var arrowGeometry = new THREE.PlaneGeometry(arrowWidth, arrowHeight, wIncrement, hIncrement);
  var arrowMaterial = new THREE.MeshBasicMaterial( { map: arrowTex, transparent: true } );
  arrow = new THREE.Mesh(arrowGeometry, arrowMaterial);
  arrow.position.z = .01;
  scene1.add(arrow);
  currentFrame = totalFrames-1;

//  setInterval(getStatus, 1000);
  setTimeout(getVideoFrame, 1000);
  mainLoop();
}

function drawFrame(){
  try {
    video_context.drawImage(video, 0, 0);
  } catch(err) {
    console.log(err);
    console.trace();
  }
}

function mainLoop()
{
  if(!paused)
  {
    updateAnimations();
    if_renderer.render(scene1, camera1);
    video_renderer.render(scene2, camera2);
    requestAnimationFrame(mainLoop);
  }
}

function updateAnimations()
{
  dt = clock.getDelta();

  // If the animation has not finished, advance the frame at a controlled rate.
  if(currentFrame<(totalFrames-1))
  {
    elapsedTime += dt;
    if( elapsedTime > .05)
    {
      elapsedTime = 0;
      currentFrame += 1;
    }
  }

  arrowTex.offset.x = currentFrame/totalFrames;
}

function resizeFunc()
{
  var height = $(window).height();
  IF_HEIGHT = VIDEO_HEIGHT = height * 0.7;
  IF_WIDTH  = IF_HEIGHT * IF_ASPECT_RATIO;
  VIDEO_WIDTH  = VIDEO_HEIGHT * VIDEO_ASPECT_RATIO;
  $("#if_container").width(IF_WIDTH);
  $("#if_container").height(IF_HEIGHT);
  $("#video_container").width(VIDEO_WIDTH);
  $("#video_container").height(VIDEO_HEIGHT);
  $("[type=button]").height(height * 0.05);
  $("#messages").height(height * 0.2);
  if_renderer.setSize(IF_WIDTH, IF_HEIGHT);
  video_renderer.setSize(VIDEO_WIDTH, VIDEO_HEIGHT);
}

function getCoords(event)
{
  mouseX = event.clientX;
  mouseY = event.clientY;

  // Convert mouseX and mouseY to the range -.5*range,+.5*range
  var x= mouseX-IF_WIDTH/2;
  var z=-mouseY+IF_HEIGHT/2;

  // Convert x and y to the range -6,+6 feet
  x = x/(IF_WIDTH/2) * 6;
  z = z/(IF_HEIGHT/2)* 6;

  // Round to the nearest .5 foot
  x = Math.floor(x) + 0.5;
  z = Math.floor(z) + 0.5;

  // Place the arrow animation and set it to the first frame
  arrow.position.x = x;
  arrow.position.y = z;
  currentFrame = 0;

  // Convert coordinates to meters and send to drone
  var METERS_PER_FOOT = 0.3048;
  x = x * METERS_PER_FOOT;
  y = 1.0;
  z = z * METERS_PER_FOOT;

  sendMessage("/uav/0/goto?x="+x+"&y="+y+"&z="+z+"&number="+message_count, gotoResponse, false );
  showMessage("normalMsg","X: "+ x.toFixed(4) +" Y: "+ y.toFixed(4) +" Z: "+ z.toFixed(4));
}

function getStatus()
{
  sendMessage("/uav/0/status?number="+message_count, statusResponse, false);
}

function getVideoFrame()
{
  sendMessage("/uav/0/video?number="+message_count, videoResponse, true);
  if(!paused)
  {
    setTimeout(getVideoFrame, 100);
  }
}

function takeOff()
{
  sendMessage("/uav/0/takeoff?number="+message_count, takeOffResponse, false);
}

function land()
{
  sendMessage("/uav/0/land?number="+message_count, landResponse, false);
}

function sendMessage(url, callBackFunc, binaryData)
{
  $.ajax({
    url: url,
    timeout: 5000,
    success: callBackFunc,
    error: timeOut,
    beforeSend: function(xhr, binaryData) {
		if(binaryData)
			xhr.overrideMimeType("text/plain; charset=x-user-defined");
		}

		});
  message_count+=1;
}

function statusResponse(data)
{
}

function videoResponse(data, status, xmlHttp)
{
  showMessage("normalMsg", status);
  if(xmlHttp.readyState==4 && xmlHttp.status==200)
  {
    //Extract Command
    var response=xmlHttp.responseText.substr(6,xmlHttp.responseText.length-6);

	//Remove End Whitespace
	while(response.length > 0 && response[response.length-1]!='?')
	{
		response=response.substr(0,response.length-1);
	}

	--response.length;


    for(var ii=0;ii<response.length;++ii)
      data_array[ii]=response.charCodeAt(ii);

    var map = new THREE.DataTexture(data_array, videoWidth, videoHeight, THREE.RGBFormat );
    map.needsUpdate = true;
    video.material.map=map;
  }
}

function takeOffResponse(data)
{
}

function landResponse(data)
{
}

function gotoResponse(data)
{
}

function errorCount()
{
  if(errorCount.val == undefined)
    errorCount.val=1;
  else
    errorCount.val += 1;

  return errorCount.val;
}

function timeOut()
{
  showMessage("errorMsg", "Error: No response from server.");
}

function showMessage(msgType, message)
{
  if(msgType == "errorMsg")
  {
    if(errorCount.val == undefined)
    {
      $("#messages").append("<div  class='errorMsg' id='timeOut'></div>");
    }
    $("#timeOut").html("("+errorCount()+")"+message);
  }
  else
  {
    $("#messages").append("<div class='"+msgType+"'>"+message+"</div>");
  }
}

function togglePause()
{
  paused = !paused;
  if(!paused)
  {
    setTimeout(getVideoFrame, 1000);
    $("#pause").val("Pause");
    requestAnimationFrame(mainLoop);
  }
  else
  {
    $("#pause").val("Resume");
  }
}

</script>

</html>
